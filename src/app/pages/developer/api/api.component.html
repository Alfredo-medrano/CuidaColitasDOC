<div class="doc-page">
    <div class="api-header">
        <h1>üìö API Reference & Data Architecture</h1>
        <div class="version-info">
            <span class="version-badge">Versi√≥n: 1.0.0</span>
            <span class="tech-badge">Backend: Supabase (PostgreSQL)</span>
            <span class="tech-badge">Cliente: React Native</span>
        </div>
    </div>
    <p class="lead">Documentaci√≥n completa de la capa de datos, hooks personalizados para interactuar con el backend e
        integraciones externas del sistema CuidaColitasAPP.</p>

    <app-info-card type="info" title="Para Desarrolladores üë®‚Äçüíª">
        <p>Esta secci√≥n documenta todos los m√©todos, hooks y estructuras de datos que utiliza la aplicaci√≥n. Use esta
            referencia para mantener consistencia en el desarrollo y entender la arquitectura de datos.</p>
    </app-info-card>

    <!-- Cliente Supabase Core -->
    <section class="doc-section">
        <h2>1Ô∏è‚É£ Cliente Supabase (Core)</h2>
        <p>El cliente se inicializa como un <strong>Singleton</strong> para gestionar la conexi√≥n persistente con el
            backend.</p>

        <div class="file-reference">
            <span class="file-icon">üìÑ</span>
            <strong>Archivo:</strong> <code>src/api/Supabase.js</code>
        </div>

        <app-info-card type="tip" title="Configuraci√≥n">
            <p>Utiliza <code>AsyncStorage</code> para la persistencia de sesi√≥n en dispositivos m√≥viles, asegurando que
                el usuario permanezca autenticado entre reinicios de la app.</p>
        </app-info-card>

        <app-code-block filename="src/api/Supabase.js" language="javascript"
            [code]="supabaseClientCode"></app-code-block>

        <h3>Caracter√≠sticas Clave:</h3>
        <ul>
            <li>‚úÖ <strong>Patr√≥n Singleton:</strong> Una √∫nica instancia compartida en toda la app</li>
            <li>‚úÖ <strong>Auto-refresh de tokens:</strong> Renueva autom√°ticamente tokens JWT expirados</li>
            <li>‚úÖ <strong>Persistencia de sesi√≥n:</strong> El usuario se mantiene logueado</li>
            <li>‚úÖ <strong>Storage local:</strong> Usa AsyncStorage para React Native</li>
        </ul>
    </section>

    <!-- Autenticaci√≥n -->
    <section class="doc-section">
        <h2>2Ô∏è‚É£ Autenticaci√≥n (Auth API)</h2>
        <p>Gestionada globalmente a trav√©s de <code>AuthContext.js</code>. Todos los m√©todos de autenticaci√≥n est√°n
            centralizados.</p>

        <div class="file-reference">
            <span class="file-icon">üìÑ</span>
            <strong>Context:</strong> <code>src/context/AuthContext.js</code>
        </div>

        <h3>M√©todos Disponibles:</h3>

        <div class="api-methods">
            <div class="method-card">
                <div class="method-header">
                    <h4>üîê signIn</h4>
                    <span class="method-badge">auth.signInWithPassword()</span>
                </div>
                <p><strong>Descripci√≥n:</strong> Inicia sesi√≥n con credenciales de correo y contrase√±a.</p>

                <div class="method-header">
                    <h4>üìù signUp</h4>
                    <span class="method-badge">auth.signUp()</span>
                </div>
                <p><strong>Descripci√≥n:</strong> Registra un nuevo usuario en <code>auth.users</code> con metadata
                    adicional.</p>

                <h5>Par√°metros:</h5>
                <ul>
                    <li><code>email</code> (string): Correo electr√≥nico</li>
                    <li><code>password</code> (string): Contrase√±a segura</li>
                    <li><code>options.data</code> (object): Metadata con <code>role</code> ('client', 'vet', 'admin')
                    </li>
                </ul>

                <app-code-block language="javascript" [code]="signUpExample"></app-code-block>
            </div>

            <div class="method-card">
                <div class="method-header">
                    <h4>üö™ signOut</h4>
                    <span class="method-badge">auth.signOut()</span>
                </div>
                <p><strong>Descripci√≥n:</strong> Cierra la sesi√≥n del usuario y limpia el almacenamiento local.</p>

                <h5>Par√°metros:</h5>
                <p>N/A</p>

                <app-code-block language="javascript" [code]="signOutExample"></app-code-block>
            </div>

            <div class="method-card">
                <div class="method-header">
                    <h4>üîë resetPassword</h4>
                    <span class="method-badge">auth.resetPasswordForEmail()</span>
                </div>
                <p><strong>Descripci√≥n:</strong> Env√≠a un correo electr√≥nico con enlace de recuperaci√≥n de contrase√±a.
                </p>

                <h5>Par√°metros:</h5>
                <ul>
                    <li><code>email</code> (string): Correo registrado en el sistema</li>
                </ul>

                <app-code-block language="javascript" [code]="resetPasswordExample"></app-code-block>
            </div>
        </div>
    </section>

    <!-- Estructura de Datos -->
    <section class="doc-section">
        <h2>3Ô∏è‚É£ Estructura de Datos (Database Schema)</h2>
        <p>Esquema relacional inferido del uso en <code>src/hooks/</code> y <code>src/screens/</code>. La base de datos
            PostgreSQL est√° alojada en Supabase.</p>

        <app-info-card type="warning" title="Integridad Referencial">
            <p>Todas las tablas utilizan <strong>Foreign Keys</strong> con pol√≠ticas de <code>ON DELETE CASCADE</code> o
                <code>SET NULL</code> seg√∫n corresponda. Las eliminaciones se propagan autom√°ticamente.
            </p>
        </app-info-card>

        <!-- Tabla Perfiles -->
        <div class="table-schema">
            <div class="table-header">
                <h3>üë§ Tabla: <code>perfiles</code> (Usuarios)</h3>
                <span class="table-source">Fuente: <code>src/context/AuthContext.js</code>,
                    <code>src/screens/Client/ProfileCliente.js</code></span>
            </div>

            <p><strong>Descripci√≥n:</strong> Almacena la informaci√≥n extendida de los usuarios (Clientes y
                Veterinarios). Vinculada a <code>auth.users</code> mediante el campo <code>id</code>.</p>

            <div class="schema-table">
                <table>
                    <thead>
                        <tr>
                            <th>Campo</th>
                            <th>Tipo</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>id</code></td>
                            <td><span class="type-badge">UUID</span></td>
                            <td>Primary Key (Vinculado a <code>auth.uid</code>)</td>
                        </tr>
                        <tr>
                            <td><code>nombre</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>Nombre completo del usuario</td>
                        </tr>
                        <tr>
                            <td><code>rol</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>'client', 'vet', 'admin'</td>
                        </tr>
                        <tr>
                            <td><code>telefono</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>N√∫mero de contacto</td>
                        </tr>
                        <tr>
                            <td><code>direccion</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>Direcci√≥n f√≠sica (para Clientes)</td>
                        </tr>
                        <tr>
                            <td><code>especialidad</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>Especialidad m√©dica (Solo Veterinarios)</td>
                        </tr>
                        <tr>
                            <td><code>avatar_url</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>URL de la imagen en Supabase Storage</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabla Mascotas -->
        <div class="table-schema">
            <div class="table-header">
                <h3>üêæ Tabla: <code>mascotas</code></h3>
                <span class="table-source">Fuente: <code>src/hooks/usePets.js</code></span>
            </div>

            <p><strong>Descripci√≥n:</strong> Cat√°logo de todas las mascotas registradas en el sistema, vinculadas a sus
                propietarios.</p>

            <div class="schema-table">
                <table>
                    <thead>
                        <tr>
                            <th>Campo</th>
                            <th>Tipo</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>id</code></td>
                            <td><span class="type-badge">UUID</span></td>
                            <td>Primary Key</td>
                        </tr>
                        <tr>
                            <td><code>propietario_id</code></td>
                            <td><span class="type-badge">UUID</span></td>
                            <td>Foreign Key ‚Üí <code>perfiles.id</code></td>
                        </tr>
                        <tr>
                            <td><code>nombre</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>Nombre de la mascota</td>
                        </tr>
                        <tr>
                            <td><code>especie</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>'Perro', 'Gato', etc.</td>
                        </tr>
                        <tr>
                            <td><code>raza</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>Raza de la mascota</td>
                        </tr>
                        <tr>
                            <td><code>fecha_nac</code></td>
                            <td><span class="type-badge">DATE</span></td>
                            <td>Fecha de nacimiento</td>
                        </tr>
                        <tr>
                            <td><code>peso</code></td>
                            <td><span class="type-badge">FLOAT</span></td>
                            <td>Peso actual en kg</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabla Citas -->
        <div class="table-schema">
            <div class="table-header">
                <h3>üìÖ Tabla: <code>citas</code></h3>
                <span class="table-source">Fuente: <code>src/hooks/useAppointments.js</code></span>
            </div>

            <p><strong>Descripci√≥n:</strong> Registro de todas las citas m√©dicas agendadas o completadas.</p>

            <div class="schema-table">
                <table>
                    <thead>
                        <tr>
                            <th>Campo</th>
                            <th>Tipo</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>id</code></td>
                            <td><span class="type-badge">UUID</span></td>
                            <td>Primary Key</td>
                        </tr>
                        <tr>
                            <td><code>id_mascota</code></td>
                            <td><span class="type-badge">UUID</span></td>
                            <td>Foreign Key ‚Üí <code>mascotas.id</code></td>
                        </tr>
                        <tr>
                            <td><code>id_veterinario</code></td>
                            <td><span class="type-badge">UUID</span></td>
                            <td>Foreign Key ‚Üí <code>perfiles.id</code> (Nullable)</td>
                        </tr>
                        <tr>
                            <td><code>fecha</code></td>
                            <td><span class="type-badge">DATE</span></td>
                            <td>Fecha de la cita</td>
                        </tr>
                        <tr>
                            <td><code>hora</code></td>
                            <td><span class="type-badge">TIME</span></td>
                            <td>Hora de la cita</td>
                        </tr>
                        <tr>
                            <td><code>estado</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>'pendiente', 'confirmada', 'completada', 'cancelada'</td>
                        </tr>
                        <tr>
                            <td><code>motivo</code></td>
                            <td><span class="type-badge">TEXT</span></td>
                            <td>Descripci√≥n del servicio solicitado</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Historial M√©dico -->
        <div class="table-schema">
            <div class="table-header">
                <h3>ü©∫ Historial M√©dico</h3>
                <span class="table-source">Fuente: <code>src/screens/Vet/HistorialMedico.js</code></span>
            </div>

            <p><strong>Descripci√≥n:</strong> Tablas sat√©lite para el expediente cl√≠nico completo de cada mascota.</p>

            <h4>Tablas Relacionadas:</h4>
            <ul>
                <li><code>vacunas</code> - Registro de vacunas aplicadas</li>
                <li><code>medicamentos</code> - Recetas y tratamientos</li>
                <li><code>visitas_medicas</code> - Consultas y diagn√≥sticos</li>
                <li><code>archivos_adjuntos</code> - Radiograf√≠as, an√°lisis, documentos</li>
            </ul>

            <app-info-card type="info" title="Esquema Modular">
                <p>Cada tabla tiene su propio <code>id_mascota</code> como Foreign Key, permitiendo consultas
                    independientes por pesta√±a en la interfaz del veterinario.</p>
            </app-info-card>
        </div>
    </section>

    <!-- Hooks Personalizados -->
    <section class="doc-section">
        <h2>4Ô∏è‚É£ Hooks Personalizados (Frontend API)</h2>
        <p>Estos hooks encapsulan la l√≥gica de negocio y las llamadas a Supabase. <strong>Los desarrolladores deben usar
                estos hooks</strong> en lugar de llamar a <code>supabase</code> directamente en los componentes.</p>

        <app-info-card type="warning" title="Patr√≥n de Dise√±o">
            <p>Todos los hooks siguen el patr√≥n de <strong>separaci√≥n de responsabilidades</strong>: el componente solo
                renderiza UI, el hook maneja la l√≥gica de datos.</p>
        </app-info-card>

        <!-- useAuth -->
        <div class="hook-card">
            <div class="hook-header">
                <h3>üîê useAuth()</h3>
                <div class="hook-meta">
                    <span class="hook-file">üìÑ <code>src/context/AuthContext.js</code></span>
                </div>
            </div>

            <h4>Exporta:</h4>
            <app-code-block language="javascript" [code]="useAuthExports"></app-code-block>

            <h4>Uso:</h4>
            <p>Control de sesi√≥n y protecci√≥n de rutas. Proporciona el estado global de autenticaci√≥n.</p>

            <h4>Ejemplo:</h4>
            <app-code-block language="javascript" [code]="useAuthExample"></app-code-block>

            <h4>M√©todos Disponibles:</h4>
            <ul>
                <li><code>login(email, password)</code> - Inicia sesi√≥n</li>
                <li><code>register(email, password, metadata)</code> - Registra nuevo usuario</li>
                <li><code>logout()</code> - Cierra sesi√≥n</li>
            </ul>
        </div>

        <!-- usePets -->
        <div class="hook-card">
            <div class="hook-header">
                <h3>üê∂ usePets(userId)</h3>
                <div class="hook-meta">
                    <span class="hook-file">üìÑ <code>src/hooks/usePets.js</code></span>
                </div>
            </div>

            <h4>Par√°metros:</h4>
            <ul>
                <li><code>userId</code> (UUID): ID del propietario</li>
            </ul>

            <h4>M√©todos:</h4>
            <div class="methods-list">
                <div class="method-item">
                    <code>fetchPets()</code>
                    <p>Query: <code>supabase.from('mascotas').select('*').eq('propietario_id', userId)</code></p>
                </div>
                <div class="method-item">
                    <code>addPet(data)</code>
                    <p>Query: <code>supabase.from('mascotas').insert(data)</code></p>
                </div>
                <div class="method-item">
                    <code>deletePet(id)</code>
                    <p>Borrado l√≥gico o f√≠sico de mascota</p>
                </div>
            </div>

            <h4>Ejemplo de Uso:</h4>
            <app-code-block language="javascript" [code]="usePetsExample"></app-code-block>
        </div>

        <!-- useAppointments -->
        <div class="hook-card">
            <div class="hook-header">
                <h3>üìÖ useAppointments()</h3>
                <div class="hook-meta">
                    <span class="hook-file">üìÑ <code>src/hooks/useAppointments.js</code></span>
                </div>
            </div>

            <h4>M√©todos:</h4>
            <div class="methods-list">
                <div class="method-item">
                    <code>fetchAppointments(role, userId)</code>
                    <p><strong>L√≥gica condicional:</strong></p>
                    <ul>
                        <li>Si es <code>vet</code>: Trae todas las citas del d√≠a asignadas al veterinario</li>
                        <li>Si es <code>client</code>: Solo trae citas de las mascotas del usuario</li>
                    </ul>
                </div>
                <div class="method-item">
                    <code>createAppointment(data)</code>
                    <p>Inserta nueva cita en tabla <code>citas</code></p>
                </div>
                <div class="method-item">
                    <code>updateStatus(id, status)</code>
                    <p>Actualiza el estado de una cita (ej. de 'pendiente' a 'confirmada')</p>
                </div>
            </div>

            <h4>Ejemplo:</h4>
            <app-code-block language="javascript" [code]="useAppointmentsExample"></app-code-block>
        </div>

        <!-- useAdminData -->
        <div class="hook-card">
            <div class="hook-header">
                <h3>üëë useAdminData()</h3>
                <div class="hook-meta">
                    <span class="hook-file">üìÑ <code>src/hooks/admin/useAdminData.js</code></span>
                </div>
            </div>

            <h4>Funci√≥n:</h4>
            <p>Agregaci√≥n de datos para el Dashboard administrativo. Genera estad√≠sticas y m√©tricas del sistema.</p>

            <h4>Queries Complejas:</h4>
            <ul>
                <li>Realiza <code>count()</code> en tablas <code>users</code>, <code>citas</code> y
                    <code>mascotas</code>
                </li>
                <li>Calcula promedios y totales</li>
                <li>Genera datos para gr√°ficos de tendencias</li>
            </ul>

            <h4>Retorna:</h4>
            <app-code-block language="javascript" [code]="useAdminDataReturn"></app-code-block>
        </div>
    </section>

    <!-- Storage -->
    <section class="doc-section">
        <h2>5Ô∏è‚É£ Storage (Archivos)</h2>
        <p>Gesti√≥n de im√°genes y documentos m√©dicos almacenados en Supabase Storage.</p>

        <h3>Buckets Configurados:</h3>
        <ul>
            <li><code>avatars</code> - Fotos de perfil de usuarios y mascotas</li>
            <li><code>medical_records</code> - Radiograf√≠as, an√°lisis, certificados</li>
        </ul>

        <h3>M√©todos Utilizados:</h3>

        <div class="storage-methods">
            <div class="storage-method">
                <h4>üì§ uploadImage(uri, path)</h4>
                <p><strong>Descripci√≥n:</strong> Convierte blob y sube archivo a Supabase Storage.</p>
                <app-code-block language="javascript" [code]="uploadImageCode"></app-code-block>
            </div>

            <div class="storage-method">
                <h4>üì• downloadImage(path)</h4>
                <p><strong>Descripci√≥n:</strong> Obtiene URL firmada o p√∫blica para mostrar la imagen.</p>
                <app-code-block language="javascript" [code]="downloadImageCode"></app-code-block>
            </div>
        </div>

        <app-info-card type="tip" title="URLs Firmadas">
            <p>Para documentos m√©dicos sensibles, use <code>createSignedUrl()</code> con expiraci√≥n de 1 hora. Para
                fotos de perfil p√∫blicas, use <code>getPublicUrl()</code>.</p>
        </app-info-card>
    </section>

    <!-- Integraciones Externas -->
    <section class="doc-section">
        <h2>6Ô∏è‚É£ Integraciones Externas (3rd Party APIs)</h2>
        <p>Servicios de terceros integrados en CuidaColitasAPP para funcionalidades extendidas.</p>

        <!-- Botpress -->
        <div class="integration-card">
            <div class="integration-header">
                <h3>ü§ñ Botpress (Chatbot IA)</h3>
                <span class="integration-type">Web Integration</span>
            </div>

            <div class="integration-details">
                <p><strong>Ubicaci√≥n:</strong> <code>src/screens/ChatBot/BotpressScreen.js</code></p>
                <p><strong>Tipo:</strong> Web Integration embebida en WebView</p>
                <p><strong>Endpoint:</strong> URL del Webchat configurado en la nube de Botpress</p>
            </div>

            <h4>Funcionalidad:</h4>
            <p>Renderiza la interfaz conversacional de Botpress dentro de un <code>WebView</code> nativo. El chatbot usa
                IA (Google Gemini) para responder preguntas sobre cuidado de mascotas.</p>

            <h4>Configuraci√≥n:</h4>
            <app-code-block language="javascript" [code]="botpressConfig"></app-code-block>

            <h4>Caracter√≠sticas:</h4>
            <ul>
                <li>üí¨ Conversaci√≥n en lenguaje natural</li>
                <li>üß† Integraci√≥n con Google Gemini AI</li>
                <li>üìö Base de conocimiento sobre cuidado veterinario</li>
                <li>üïê Disponible 24/7</li>
            </ul>
        </div>

        <!-- Expo Notifications -->
        <div class="integration-card">
            <div class="integration-header">
                <h3>üîî Expo Notifications</h3>
                <span class="integration-type">Push Notifications</span>
            </div>

            <div class="integration-details">
                <p><strong>Ubicaci√≥n:</strong> <code>src/hooks/useNotifications.js</code></p>
                <p><strong>Servicio:</strong> Expo Push Notification Service</p>
            </div>

            <h4>Funcionalidad:</h4>
            <p>Gesti√≥n de tokens push para enviar alertas a dispositivos iOS y Android.</p>

            <h4>M√©todos:</h4>
            <div class="methods-list">
                <div class="method-item">
                    <code>registerForPushNotificationsAsync()</code>
                    <p>Obtiene el token √∫nico del dispositivo (Expo Push Token)</p>
                    <app-code-block language="javascript" [code]="registerNotificationsCode"></app-code-block>
                </div>

                <div class="method-item">
                    <code>sendPushNotification(token, title, body)</code>
                    <p>Env√≠a la carga √∫til al servicio de notificaciones de Expo</p>
                    <app-code-block language="javascript" [code]="sendNotificationCode"></app-code-block>
                </div>
            </div>

            <h4>Casos de Uso:</h4>
            <ul>
                <li>üìÖ Recordatorios de citas pr√≥ximas</li>
                <li>üíâ Alertas de vacunas por vencer</li>
                <li>‚úÖ Confirmaci√≥n de citas por veterinario</li>
                <li>üí¨ Nuevos mensajes del chat</li>
            </ul>
        </div>
    </section>

    <!-- Mejores Pr√°cticas -->
    <section class="doc-section">
        <h2>üìå Mejores Pr√°cticas de Desarrollo</h2>

        <div class="best-practices-grid">
            <div class="practice-item">
                <h4>‚úÖ Usar Hooks Personalizados</h4>
                <p>Siempre use los hooks en lugar de llamar directamente a Supabase. Esto mantiene la l√≥gica
                    centralizada.</p>
            </div>

            <div class="practice-item">
                <h4>‚úÖ Manejo de Errores</h4>
                <p>Todos los hooks devuelven <code>error</code>. Siempre verifique y maneje errores apropiadamente.</p>
            </div>

            <div class="practice-item">
                <h4>‚úÖ Loading States</h4>
                <p>Use los estados <code>loading</code> o <code>isLoading</code> para mostrar indicadores visuales al
                    usuario.</p>
            </div>

            <div class="practice-item">
                <h4>‚úÖ Tipado TypeScript</h4>
                <p>Si migra a TypeScript, defina interfaces para todas las entidades de base de datos.</p>
            </div>

            <div class="practice-item">
                <h4>‚úÖ Row Level Security (RLS)</h4>
                <p>Verifique que todas las tablas tengan pol√≠ticas RLS activas para garantizar seguridad a nivel de
                    datos.</p>
            </div>

            <div class="practice-item">
                <h4>‚úÖ Documentaci√≥n de Cambios</h4>
                <p>Cualquier modificaci√≥n en el schema de base de datos debe actualizarse en esta documentaci√≥n.</p>
            </div>
        </div>
    </section>

    <app-info-card type="success" title="Documentaci√≥n Completa ‚ú®">
        <p>Esta API Reference cubre todos los aspectos t√©cnicos de CuidaColitasAPP. Para dudas adicionales, consulte el
            c√≥digo fuente o contacte al equipo de desarrollo.</p>
    </app-info-card>
</div>