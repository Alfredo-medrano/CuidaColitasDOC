<div class="doc-page">
    <h1><i class="fas fa-sitemap"></i> Arquitectura del Sistema</h1>
    <p class="lead">Arquitectura en Capas con Backend Serverless</p>

    <app-info-card type="tip" title="Definici√≥n">
        <p>CuidaColitasAPP utiliza una <strong>Arquitectura en Capas (Layered Architecture)</strong> basada en
            componentes, con el patr√≥n <strong>Cliente-Servidor</strong> y enfoque <strong>Serverless</strong> gracias a
            Supabase.</p>
    </app-info-card>

    <!-- Diagrama de Alto Nivel -->
    <section class="doc-section">
        <h2><i class="fas fa-diagram-project"></i> Diagrama de Alto Nivel</h2>
        <p>El sistema opera bajo un modelo h√≠brido donde la aplicaci√≥n m√≥vil gestiona la l√≥gica de presentaci√≥n y
            negocio, delegando la persistencia, autenticaci√≥n y almacenamiento a servicios en la nube (BaaS - Backend as
            a Service).</p>

        <div class="architecture-diagram">
            <div class="layer">
                <div class="layer-header client">CLIENTE M√ìVIL (React Native)</div>
                <div class="layer-content">
                    <div class="component">üì± Interfaz de Usuario<br /><small>(Screens/Components)</small></div>
                    <div class="component">üîÑ Gesti√≥n de Estado<br /><small>(Context API/Hooks)</small></div>
                    <div class="component">‚ö° Capa de Servicio<br /><small>(Supabase Client)</small></div>
                </div>
            </div>

            <div class="arrow-down">‚Üì Internet / HTTPS ‚Üì</div>

            <div class="layer">
                <div class="layer-header cloud">NUBE (Backend as a Service)</div>
                <div class="layer-content horizontal">
                    <div class="service">
                        <div class="service-header">SUPABASE</div>
                        <ul>
                            <li>üîê Autenticaci√≥n (Auth)</li>
                            <li>üóÑÔ∏è Base de Datos (PostgreSQL)</li>
                            <li>üìÅ Storage (Archivos)</li>
                            <li>‚ö° Realtime</li>
                        </ul>
                    </div>
                    <div class="service">
                        <div class="service-header">BOTPRESS</div>
                        <ul>
                            <li>ü§ñ Chatbot IA</li>
                            <li>üí¨ NLP</li>
                            <li>üéØ Automatizaci√≥n</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Arquitectura en 3 Capas -->
    <section class="doc-section">
        <h2><i class="fas fa-layer-group"></i> Arquitectura en 3 Capas</h2>
        <p>La aplicaci√≥n <code>src/</code> est√° estructurada en tres capas l√≥gicas que separan responsabilidades:</p>

        <div class="layers-grid">
            <!-- Capa 1: Presentaci√≥n -->
            <div class="layer-card">
                <div class="layer-title">
                    <span class="layer-number">1</span>
                    <h3>Capa de Presentaci√≥n</h3>
                </div>
                <p class="layer-subtitle">UI Layer - "Vista"</p>

                <div class="layer-details">
                    <h4>Responsabilidad:</h4>
                    <p>Lo que el usuario ve e interact√∫a. No procesa l√≥gica compleja, solo muestra datos y captura
                        eventos.</p>

                    <h4>Tecnolog√≠a:</h4>
                    <p>React Native, React Navigation</p>

                    <h4>Componentes:</h4>
                    <ul>
                        <li><strong>Screens</strong> (<code>src/screens/</code>): Vistas completas segregadas por rol
                        </li>
                        <li><strong>Components</strong> (<code>src/components/</code>): Elementos reutilizables
                            (botones, cards, layouts)</li>
                        <li><strong>Navegaci√≥n</strong>: Gestiona flujo entre pantallas (Stacks, Tabs, Drawer)</li>
                    </ul>

                    <h4>Ejemplo:</h4>
                    <p><code>ClienteHome.js</code>, <code>InfoCard.js</code>, <code>MainLayout.js</code></p>
                </div>
            </div>

            <!-- Capa 2: L√≥gica de Negocio -->
            <div class="layer-card">
                <div class="layer-title">
                    <span class="layer-number">2</span>
                    <h3>Capa de L√≥gica de Negocio</h3>
                </div>
                <p class="layer-subtitle">Business Logic Layer - "Cerebro"</p>

                <div class="layer-details">
                    <h4>Responsabilidad:</h4>
                    <p>Puente entre la vista y los datos. Aqu√≠ se toman las decisiones de la aplicaci√≥n.</p>

                    <h4>Tecnolog√≠a:</h4>
                    <p>React Hooks, Context API</p>

                    <h4>Componentes:</h4>
                    <ul>
                        <li><strong>Context</strong> (<code>src/context/</code>): Estado global (sesi√≥n, usuario)</li>
                        <li><strong>Hooks Personalizados</strong> (<code>src/hooks/</code>): L√≥gica espec√≠fica
                            encapsulada</li>
                        <li><strong>Utils</strong> (<code>src/utils/</code>): Funciones auxiliares (validaci√≥n,
                            formateo)</li>
                    </ul>

                    <h4>Ejemplo:</h4>
                    <p><code>useAppointments.js</code> - Filtra citas pasadas vs futuras, formatea fechas</p>
                    <p><code>AuthContext.js</code> - Mantiene sesi√≥n activa, distribuye rol del usuario</p>
                </div>
            </div>

            <!-- Capa 3: Datos -->
            <div class="layer-card">
                <div class="layer-title">
                    <span class="layer-number">3</span>
                    <h3>Capa de Acceso a Datos</h3>
                </div>
                <p class="layer-subtitle">Data Access Layer - "Puerta al Backend"</p>

                <div class="layer-details">
                    <h4>Responsabilidad:</h4>
                    <p>√önica capa que "conoce" la existencia del backend. Abstrae la conexi√≥n a la base de datos.</p>

                    <h4>Tecnolog√≠a:</h4>
                    <p>Supabase JS Client</p>

                    <h4>Componentes:</h4>
                    <ul>
                        <li><strong>API Client</strong> (<code>src/api/Supabase.js</code>): Cliente singleton de
                            Supabase</li>
                        <li>Expone m√©todos: <code>select()</code>, <code>insert()</code>, <code>update()</code>,
                            <code>delete()</code>
                        </li>
                    </ul>

                    <h4>Ejemplo:</h4>
                    <app-code-block filename="src/api/Supabase.js" language="javascript"
                        [code]="supabaseSingletonExample"></app-code-block>
                </div>
            </div>
        </div>
    </section>

    <!-- Arquitectura del Backend -->
    <section class="doc-section">
        <h2><i class="fas fa-cloud"></i> Arquitectura del Backend (Supabase)</h2>
        <p>Al no tener un servidor backend tradicional (Node.js/Express), la arquitectura delega a
            <strong>Supabase</strong> como infraestructura unificada:
        </p>

        <div class="backend-components">
            <div class="backend-card">
                <h3>üóÑÔ∏è Base de Datos Relacional</h3>
                <p><strong>PostgreSQL</strong></p>
                <ul>
                    <li>Tablas: <code>users</code>, <code>appointments</code>, <code>pets</code>,
                        <code>medical_records</code>
                    </li>
                    <li>Integridad referencial (relaciones entre entidades)</li>
                    <li>Triggers y funciones SQL</li>
                </ul>
            </div>

            <div class="backend-card">
                <h3>üîê Autenticaci√≥n</h3>
                <p><strong>GoTrue (Supabase Auth)</strong></p>
                <ul>
                    <li>Registro, login, recuperaci√≥n de contrase√±a</li>
                    <li>JWT Tokens para sesiones</li>
                    <li>Provee UID √∫nico por usuario</li>
                </ul>
            </div>

            <div class="backend-card">
                <h3>üìÅ Storage</h3>
                <p><strong>Supabase Storage</strong></p>
                <ul>
                    <li>Buckets para im√°genes (perfiles, mascotas)</li>
                    <li>Documentos PDF (recetas, resultados)</li>
                    <li>URLs firmadas para acceso seguro</li>
                </ul>
            </div>

            <div class="backend-card">
                <h3>üîí Seguridad (RLS)</h3>
                <p><strong>Row Level Security</strong></p>
                <ul>
                    <li>Pol√≠ticas SQL a nivel de fila</li>
                    <li>Un cliente solo ve sus propias mascotas</li>
                    <li>Veterinarios acceden a pacientes asignados</li>
                </ul>
                <app-code-block filename="Ejemplo RLS Policy" language="sql" [code]="rlsExample"></app-code-block>
            </div>

            <div class="backend-card">
                <h3>‚ö° Realtime</h3>
                <p><strong>Supabase Realtime</strong></p>
                <ul>
                    <li>Mensajes de chat en tiempo real</li>
                    <li>Notificaciones instant√°neas</li>
                    <li>Sincronizaci√≥n autom√°tica de datos</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Flujo de Datos -->
    <section class="doc-section">
        <h2><i class="fas fa-arrows-rotate"></i> Flujo de Datos</h2>
        <p>Caso de uso: <strong>"Crear una Cita"</strong></p>

        <div class="data-flow">
            <div class="flow-step">
                <div class="flow-number">1</div>
                <div class="flow-content">
                    <h4>Input (UI)</h4>
                    <p>Usuario llena el formulario en <code>SolicitarCita.js</code></p>
                </div>
            </div>

            <div class="flow-arrow">‚Üì</div>

            <div class="flow-step">
                <div class="flow-number">2</div>
                <div class="flow-content">
                    <h4>Validaci√≥n (Utils)</h4>
                    <p>Funci√≥n <code>validation.js</code> verifica campos obligatorios</p>
                </div>
            </div>

            <div class="flow-arrow">‚Üì</div>

            <div class="flow-step">
                <div class="flow-number">3</div>
                <div class="flow-content">
                    <h4>Procesamiento (Hook)</h4>
                    <p><code>useAppointmentForm.js</code> estructura el objeto de datos</p>
                </div>
            </div>

            <div class="flow-arrow">‚Üì</div>

            <div class="flow-step">
                <div class="flow-number">4</div>
                <div class="flow-content">
                    <h4>Petici√≥n (API)</h4>
                    <p><code>supabase.from('appointments').insert(...)</code></p>
                </div>
            </div>

            <div class="flow-arrow">‚Üì</div>

            <div class="flow-step">
                <div class="flow-number">5</div>
                <div class="flow-content">
                    <h4>Backend (Supabase)</h4>
                    <p>Verifica token, guarda en PostgreSQL</p>
                </div>
            </div>

            <div class="flow-arrow">‚Üì</div>

            <div class="flow-step">
                <div class="flow-number">6</div>
                <div class="flow-content">
                    <h4>Respuesta</h4>
                    <p>Supabase confirma √©xito o error</p>
                </div>
            </div>

            <div class="flow-arrow">‚Üì</div>

            <div class="flow-step">
                <div class="flow-number">7</div>
                <div class="flow-content">
                    <h4>Actualizaci√≥n (UI)</h4>
                    <p>Muestra <code>LoadingOverlay</code>, redirige a lista de citas</p>
                </div>
            </div>
        </div>

        <app-code-block filename="Flujo de Datos - C√≥digo" language="javascript"
            [code]="dataFlowExample"></app-code-block>
    </section>

    <!-- Patrones de Dise√±o -->
    <section class="doc-section">
        <h2><i class="fas fa-palette"></i> Patrones de Dise√±o</h2>

        <div class="patterns-grid">
            <div class="pattern-card">
                <h3>1Ô∏è‚É£ Singleton</h3>
                <p class="pattern-desc">Una √∫nica instancia compartida de la conexi√≥n a Supabase</p>
                <p><strong>D√≥nde:</strong> <code>src/api/Supabase.js</code></p>
                <p><strong>Por qu√©:</strong> Evita m√∫ltiples conexiones a la base de datos, optimiza recursos</p>
                <app-code-block language="javascript" [code]="supabaseSingletonExample"></app-code-block>
            </div>

            <div class="pattern-card">
                <h3>2Ô∏è‚É£ Observer / Pub-Sub</h3>
                <p class="pattern-desc">React Context act√∫a como publicador que notifica cambios</p>
                <p><strong>D√≥nde:</strong> <code>AuthContext.js</code></p>
                <p><strong>Por qu√©:</strong> Todos los componentes reciben actualizaciones autom√°ticas del estado de
                    autenticaci√≥n</p>
                <app-code-block language="javascript" [code]="authContextExample"></app-code-block>
            </div>

            <div class="pattern-card">
                <h3>3Ô∏è‚É£ Container / Presentational</h3>
                <p class="pattern-desc">Separaci√≥n entre l√≥gica y presentaci√≥n</p>
                <p><strong>Container:</strong> Screens (manejan l√≥gica y hooks)</p>
                <p><strong>Presentational:</strong> Components (solo reciben props)</p>
                <app-code-block language="javascript" [code]="containerPresentationalExample"></app-code-block>
            </div>

            <div class="pattern-card">
                <h3>4Ô∏è‚É£ RBAC (Role-Based Access Control)</h3>
                <p class="pattern-desc">Control de acceso basado en roles</p>
                <p><strong>D√≥nde:</strong> <code>App.js</code>, pol√≠ticas RLS</p>
                <p><strong>Por qu√©:</strong> Cada usuario ve solo lo que le corresponde seg√∫n su rol</p>
                <app-code-block language="javascript" [code]="rbacExample"></app-code-block>
            </div>
        </div>
    </section>

    <!-- Integraciones Externas -->
    <section class="doc-section">
        <h2><i class="fas fa-plug"></i> Integraciones Externas</h2>

        <div class="integrations">
            <div class="integration-card">
                <h3>ü§ñ Botpress (Chatbot IA)</h3>
                <p><strong>M√©todo:</strong> Integraci√≥n v√≠a Webview o API</p>
                <p><strong>Funci√≥n:</strong> La app act√∫a como contenedor visual del bot conversacional</p>
                <p><strong>Beneficio:</strong> Soporte automatizado 24/7 sin sobrecargar el backend principal</p>
                <ul>
                    <li>Respuestas instant√°neas a preguntas frecuentes</li>
                    <li>Recomendaciones de cuidado de mascotas</li>
                    <li>Recordatorios de vacunas y citas</li>
                </ul>
            </div>

            <div class="integration-card">
                <h3>üåê Google Gemini AI</h3>
                <p><strong>M√©todo:</strong> API REST</p>
                <p><strong>Funci√≥n:</strong> Procesamiento de lenguaje natural avanzado</p>
                <p><strong>Uso:</strong> Mejorar respuestas del chatbot con IA generativa</p>
            </div>
        </div>
    </section>

    <!-- Ventajas de la Arquitectura -->
    <section class="doc-section">
        <h2><i class="fas fa-star"></i> Ventajas de esta Arquitectura</h2>

        <div class="advantages-grid">
            <div class="advantage-card">
                <h4>üìà Escalabilidad</h4>
                <p>Supabase maneja autom√°ticamente la carga, sin necesidad de gestionar servidores</p>
            </div>

            <div class="advantage-card">
                <h4>üöÄ Desarrollo R√°pido</h4>
                <p>Backend as a Service reduce tiempo de desarrollo en un 60%</p>
            </div>

            <div class="advantage-card">
                <h4>üîí Seguridad Integrada</h4>
                <p>RLS a nivel de base de datos, no solo en frontend</p>
            </div>

            <div class="advantage-card">
                <h4>üí∞ Costo Efectivo</h4>
                <p>Sin servidores que mantener, pago por uso real</p>
            </div>

            <div class="advantage-card">
                <h4>üîÑ Tiempo Real</h4>
                <p>Chat y notificaciones instant√°neas out-of-the-box</p>
            </div>

            <div class="advantage-card">
                <h4>üß© Modularidad</h4>
                <p>Capas bien definidas facilitan mantenimiento y testing</p>
            </div>
        </div>
    </section>

    <!-- Resumen -->
    <app-info-card type="success" title="Resumen Arquitect√≥nico">
        <p><strong>CuidaColitasAPP utiliza una arquitectura React Native con Expo desacoplada, apoyada en Supabase como
                backend serverless.</strong></p>
        <p>Prioriza la <strong>modularidad</strong> mediante el uso de Hooks personalizados para la l√≥gica de negocio y
            Context API para el estado global, asegurando <strong>escalabilidad</strong> y una clara <strong>separaci√≥n
                de responsabilidades</strong> entre la interfaz de usuario y la gesti√≥n de datos.</p>
    </app-info-card>

    <!-- Enlaces Relacionados -->
    <section class="doc-section">
        <h2>üìö Documentaci√≥n Relacionada</h2>
        <ul>
            <li><a routerLink="/developer/structure">Estructura del Proyecto</a> - Organizaci√≥n de carpetas y archivos
            </li>
            <li><a routerLink="/technical/database">Base de Datos</a> - Esquema y relaciones</li>
            <li><a routerLink="/technical/rls">RLS Policies</a> - Seguridad a nivel de datos</li>
            <li><a routerLink="/developer/api">API Reference</a> - M√©todos de Supabase</li>
        </ul>
    </section>
</div>